# å‰è¨€

Ubuntu ä¹Ÿæ˜¯åŸºäº Debian çš„å‘è¡Œç‰ˆæœ¬ï¼Œæ‰€ä»¥æœ¬ç¯‡æ–‡ç« ä¸ä»…é€‚ç”¨äº Debian åŒæ ·ä¹Ÿé€‚ç”¨äº Ubuntuã€‚

å”¯ä¸€éœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒUbuntu è‡ª18.0 å¼€å§‹å…³äºç½‘ç»œçš„é…ç½®åšäº†è°ƒæ•´ã€‚åœ¨18.0ä¹‹å‰ä½¿ç”¨çš„ç½‘ç»œé…ç½®æ˜¯ `Networkï¼Œ18`.0 ä»¥åŠä¹‹åçš„ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯ `Netplan` ä½œä¸ºç½‘ç»œé…ç½®ã€‚

å¦‚æœä½ ä¸ç¡®å®šå½“å‰æ“ä½œç³»ç»Ÿä½¿ç”¨çš„æ˜¯ `Network` è¿˜æ˜¯ `Netplan` å¯ä»¥ä½¿ç”¨ `man` å‘½ä»¤æµ‹è¯•ä¸‹ï¼š


```bash
$ man networks

$ man netplan
```

æ¯”å¦‚å½“å‰ Debian å‘è¡Œç‰ˆï¼ˆBusterï¼‰ä½¿ç”¨çš„æ˜¯ `networks`ï¼Œå¦‚æœä½¿ç”¨ `man` æŸ¥çœ‹ `netplan` å°±ä¼šæç¤ºï¼š

```
No manual entry for netplan
```

ä¸‹é¢æ˜¯ Ubuntu å’Œ Debian å‘è¡Œç‰ˆä½¿ç”¨çš„ç½‘ç»œé…ç½®ï¼Œå½“ç„¶æœ€ç®€å•çš„æ–¹å¼è¿˜æ˜¯ç›´æ¥ä½¿ç”¨ `man` å‘½ä»¤è¿›è¡Œç¡®è®¤ã€‚


| **ç½‘ç»œé…ç½®** | **Debian**                                | **Ubuntu**             | **é…ç½®æ–‡ä»¶ä½ç½®** |
| :----------- | :---------------------------------------- | :--------------------- | :--------------- |
| network      | Debianå„ç³»åˆ—å‘å‹ç‰ˆæœ¬ï¼ˆå½“å‰æœ€æ–°æ˜¯ Busterï¼‰ | Ubuntu18ä¹‹å‰å‘è¡Œç‰ˆæœ¬   | `/etc/network`   |
| netplan      |                                           | Ubuntu18åŠä¹‹åå‘è¡Œç‰ˆæœ¬ | `/etc/netplan`   |


çŸ¥é“è¿™äº›åŒºåˆ«ä¹‹åå°±å¼€å§‹åšå…·ä½“è¯´æ˜ã€‚é¦–å…ˆï¼Œå…ˆä»‹ç»åŸºäº network çš„ç½‘ç»œé…ç½®ã€‚

# åŸºäº Network é…ç½®ç½‘ç»œ


| **Note**                                                     |
| :----------------------------------------------------------- |
| è™½ç„¶è¯´æœ¬æ–‡æ˜¯ä»‹ç» Debian ç³»åˆ—å‘è¡Œç‰ˆå¦‚ä½•è®¾ç½®é™æ€ IPï¼Œä½†æ˜¯åªè¦ä½¿ç”¨ `Network` çš„å‘è¡Œç‰ˆå…¶å®éƒ½é€‚ç”¨çš„ï¼ˆæ¯”å¦‚ CentOS å°±æ˜¯ä½¿ç”¨ Networkï¼‰ï¼ |


Network çš„é…ç½®æ–‡ä»¶æ˜¯åœ¨ `/etc/network` ç›®å½•ä¸‹ï¼Œè¯¥ç›®å½•ä¸‹æœ‰æ–‡ä»¶ï¼Œè€Œç”¨äºé…ç½®ç½‘å¡çš„åˆ™æ˜¯ `interfaces` æ–‡ä»¶ï¼š

```bash
$ ls /etc/network
if-down.d  if-post-down.d  if-pre-up.d	if-up.d  interfaces  interfaces.d
```

`interfaces` æ˜¯æ¥å£çš„æ„æ€ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯ç”¨äºé…ç½® Network çš„ç½‘ç»œæ¥å£ï¼ˆæˆ‘ä»¬é€šå¸¸è¯´çš„ç½‘å¡æŒ‡çš„å°±æ˜¯ç½‘ç»œæ¥å£ï¼‰ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `cat` å‘½ä»¤æŸ¥çœ‹è¯¥æ–‡ä»¶ä¸­å½“å‰å·²å­˜åœ¨çš„é…ç½®ä¿¡æ¯ï¼š

```bash
cat /etc/network/interfaces
```

ä¸‹é¢å±•ç¤ºçš„å†…å®¹æ˜¯æˆ‘å½“å‰ç³»ç»Ÿçš„é»˜è®¤ç½‘ç»œé…ç½®ä¿¡æ¯ï¼Œå…¶ä¸­ `ens33` å°±æ˜¯æˆ‘çš„ç³»ç»Ÿçš„ç½‘ç»œæ¥å£ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ç½‘å¡ï¼š

```bash
# The loopback network interface
source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

# The primary network interface
auto ens33
allow-hotplug ens33
iface ens33 inet dhcp
```

è¿™ä¸ªæ–‡ä»¶é‡Œæœ‰ä¸¤ä¸ªç½‘ç»œæ¥å£ï¼Œåˆ†åˆ«æ˜¯ `lo` å’Œ `ens33`ã€‚`lo` è¡¨ç¤ºçš„æ˜¯å›ç¯ç½‘ç»œæ¥å£ï¼Œè€Œ `ens33` å°±æ˜¯ç‰©ç†ç½‘å¡ï¼Œæˆ‘ä»¬çš„ IP å°±æ˜¯ç»‘å®šåœ¨è¯¥ç½‘å¡ä¸Šçš„ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `iproute2` å‘½ä»¤æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„ç½‘ç»œä¿¡æ¯ï¼š

```bash
$ ip -c addr show
```

è¾“å‡ºç¤ºä¾‹ï¼š

![show-ip-1637739047LlljmB](http://linux-media.knowledge.ituknown.cn/NetworkManager/Debian-StaticIP/show-ip-1637739047LlljmB.png)

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ IP éƒ½æ˜¯ç»‘å®šåœ¨ `ens33` ç½‘å¡ä¸Šçš„ï¼Œä¸Šé¢æˆªå›¾ä¸­ç»‘å®šçš„ IPv4 åœ°å€æ˜¯ `172.17.13.167/24`ï¼ŒIPv6 åœ°å€æ˜¯ `fe80::20c:29ff:fe1b:a908/64`ã€‚ç¨åæˆ‘ä»¬å°±å°† IPv4 æˆ– IPv6 è®¾ç½®æˆé™æ€çš„ï¼ˆæ¯ä¸ªç³»ç»Ÿä¸Šçš„ç½‘å¡åå¯èƒ½ä¸ä¸€æ ·ï¼Œæˆ‘çš„æ˜¯ `ens33` ä½ çš„å¯èƒ½æ˜¯ `eth0`ã€‚å…·ä½“æ˜¯ä»€ä¹ˆå¯ä»¥ä½¿ç”¨ `ip -c route list` å‘½ä»¤æŸ¥ä¸‹ï¼‰ã€‚

**è¿™é‡Œè¦ç‰¹åˆ«è¯´ä¸‹æ¥å£æ–‡ä»¶ä¸­çš„ `auto` å’Œ `allow-hotplug` ä¸¤ä¸ªé…ç½®ï¼š**

`auto` æŒ‡çš„æ˜¯å¯åŠ¨ç³»ç»Ÿæ—¶è‡ªåŠ¨å¯åŠ¨ç½‘ç»œæ¥å£ï¼Œå¦‚æœä¸é…ç½®è¯¥é€‰é¡¹ï¼Œé‚£ä¹ˆå¯åŠ¨æˆ–é‡å¯ç³»ç»Ÿæ—¶å°±ä¸ä¼šå¯åŠ¨è¯¥ç½‘ç»œæ¥å£ã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨ `ssh` è¿›è¡Œè¿œç¨‹ç™»å½•æ—¶å¦‚æœé‡åˆ°ç™»å½•å¤±è´¥ï¼Œé‚£ä¹ˆå¯èƒ½åŸå› å°±æ˜¯æ²¡æœ‰é…ç½®è¯¥é€‰é¡¹ï¼Œå¯¼è‡´ç½‘å¡è¿˜å¤„äº `DOWN` çŠ¶æ€ï¼ˆå¯ä»¥ä½¿ç”¨ `ip -c link list` å‘½ä»¤æŸ¥çœ‹ï¼‰ã€‚

è€Œ `allow-hotplug` åˆ™æ˜¯å½“å†…æ ¸ä»ç½‘ç»œæ¥å£æ£€æµ‹åˆ°çƒ­æ’æ‹”äº‹ä»¶åæ‰ä¼šå¯åŠ¨è¯¥ç½‘ç»œæ¥å£ã€‚å¦‚æœç³»ç»Ÿå¯åŠ¨æ—¶è¯¥ç½‘ç»œæ¥å£æ²¡æœ‰æ’å…¥ç½‘çº¿ï¼Œåˆ™ç³»ç»Ÿä¸ä¼šå¯åŠ¨è¯¥ç½‘å¡ã€‚ç³»ç»Ÿå¯åŠ¨åï¼Œå¦‚æœæ’å…¥ç½‘çº¿ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¯åŠ¨è¯¥ç½‘ç»œæ¥å£ã€‚

æœ‰å…³ `auto` å¯ `allow-hotplug` çš„åŒºåˆ«å¯å‚è€ƒæ–‡ç« æœ€åçš„èµ„æºé“¾æ¥ğŸ”—ã€‚

**ç°åœ¨å†æ¥è¯´ä¸‹ `iface` é…ç½®ï¼š**ï¼š

`iface` æŒ‡å®šè¦é…ç½®çš„ç½‘ç»œæ¥å£ï¼Œæ¯”å¦‚ä¸Šé¢ç¤ºä¾‹ä¸­çš„å†…å®¹ï¼š

```
iface ens33 inet dhcp
```

`inet` æŒ‡çš„æ˜¯ IPv4 ç½‘ç»œåè®®ï¼Œæ„æ€å°±æ˜¯é…ç½® `ens33` ç½‘å¡ä¸Šçš„ IPv4 ç½‘ç»œï¼Œå¦‚æœè¦é…ç½® IPv6 çš„è¯ï¼Œå°† `inet` ä¿®æ”¹ä¸º `inet6` å°±å¥½äº†ã€‚

ç»§ç»­çœ‹åé¢çš„ `dhcp`ï¼Œè¿™ä¸ªæŒ‡çš„æ˜¯åŠ¨æ€è·å–çš„æ„æ€ï¼Œå°† `iface` è¿èµ·æ¥ä¸€èµ·è§£é‡Šå°±æ˜¯ï¼šé…ç½® `ens33` ç½‘ç»œæ¥å£ï¼Œä»¥åŠ¨æ€å½¢å¼é…ç½®è¯¥æ¥å£ä¸Šçš„ IPv4 ç½‘ç»œåè®®ï¼

è¿™æ ·çš„è¯ï¼Œå½“æˆ‘ä»¬ç³»ç»Ÿå¯åŠ¨æ—¶å°±ä¼šåŠ¨æ€åˆ†é… IPv4 åœ°å€ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå½“æˆ‘ä»¬è¿æ¥ç½‘ç»œåå°±ä¼šæœ‰ä¸€ä¸ªå±€åŸŸç½‘ IP çš„åŸå› ã€‚

ç°åœ¨æ¥çœ‹ä¸‹æ€ä¹ˆé…ç½®é™æ€ IPï¼š

## é…ç½®é™æ€ IP

| **è¯´æ˜**                                                   |
| :--------------------------------------------------------- |
| ä¸‹é¢ä»‹ç»çš„å†…å®¹éƒ½å¯ä»¥ä½¿ç”¨ `man` å‘½ä»¤æŸ¥çœ‹ï¼š` man interfaces` |


ç°åœ¨æ¥çœ‹ä¸‹é™æ€ IP è¯¥æ€ä¹ˆé…ç½®ã€‚åœ¨ä¿®æ”¹ä¹‹å‰å…ˆè¿›è¡Œä¸‹å¤‡ä»½ï¼Œè¿™æ˜¯ä¿®æ”¹ç³»ç»Ÿé…ç½®çš„å¿…é¡»æ­¥éª¤ï¼Œå¯ç”¨äºé…ç½®è¿˜åŸï¼Œåº”è¯¥å…»æˆéšæ—¶å¤‡ä»½çš„å¥½ä¹ æƒ¯ï¼š

```bash
sudo cp /etc/network/interfaces /etc/network/interfaces.bak
```

| **Note**                                                     |
| :----------------------------------------------------------- |
| ä¿®æ”¹ç³»ç»Ÿé…ç½®éœ€è¦æœ‰è¶…çº§ç®¡ç†å‘˜æƒé™ï¼Œä¹Ÿå°±æ˜¯ `root` ç”¨æˆ·æˆ–èƒ½å¤Ÿä½¿ç”¨ `sudo` æƒé™çš„ç”¨æˆ·ï¼ |


é¦–å…ˆå‘¢ï¼Œå°† `iface` æŒ‡å®šçš„ç½‘å¡ç”± `dhcp` ä¿®æ”¹ä¸º `static`ï¼Œè¡¨ç¤ºè¦å°†è¯¥ç½‘å¡è®¾ç½®ä¸ºé™æ€ï¼Œè‡³äºç½‘ç»œåè®®çš„è¯å°±ä¸æ”¹äº†ï¼Œå› ä¸ºæˆ‘ä»¬è¦é…ç½®çš„å°±æ˜¯ IPv4ï¼Œå¦‚æœä½ æƒ³è¦é…ç½®çš„æ˜¯ IPv6ï¼Œå°±å°† `inet` ä¿®æ”¹ä¸º `inet6` å³å¯ï¼Œå¦‚ä¸‹ï¼š

```
iface ens33 inet static
```

ä¹‹åä½¿ç”¨ `address` å’Œ `gateway` æŒ‡å®šè¦è®¾ç½®çš„é™æ€ IP å’Œç½‘ç»œå°±å¥½äº†ï¼ŒIP çš„è¯å°±è®¾ç½®ä¸º `172.17.13.167/24` å°±å¥½ï¼Œå°±æ˜¯ä¹‹å‰ä½¿ç”¨ `ip -c addr show` å‘½ä»¤è¾“å‡ºçš„ IPã€‚

è‡³äº `gateway` çš„è¯ï¼Œæˆ‘ä»¬ä¸è¦åšä»»ä½•ä¿®æ”¹ï¼Œä¾ç„¶ä½¿ç”¨å½“å‰å±€åŸŸç½‘çš„ç½‘å…³IPï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥è·å–äº†ï¼š

```bash
$ ip -c route list
```

è¾“å‡ºç¤ºä¾‹ï¼š

![show-route-1637829825BkqF0Q](http://linux-media.knowledge.ituknown.cn/NetworkManager/Debian-StaticIP/show-route-1637829825BkqF0Q.png)

å…¶ä¸­ default æ å¯¹åº”çš„ IP å°±æ˜¯æˆ‘ä»¬çš„ç½‘å…³äº†ï¼ŒIP æ˜¯ `172.17.13.254`ã€‚

å°†è¿™ä¸¤ä¸ªä¿¡æ¯é…ç½®åˆ°æ¥å£æ–‡ä»¶ä¸­å³å¯ï¼Œå¦‚ä¸‹ï¼š

```
iface ens33 inet static
     address 172.17.13.167/24
     gateway 172.17.13.254
```



| **æ³¨æ„ç¼©è¿›**                                                 |
| :----------------------------------------------------------- |
| ä¸€å®šè¦æ³¨æ„ç¤ºä¾‹ä¸­çš„ç¼©è¿›ï¼ï¼å¦å¤–ï¼Œæœ‰äº›èµ„æ–™æç¤ºè¿˜è¦é…ç½®å­ç½‘æ©ç  `netmask`ã€‚ä¸è¿‡è¿™ä¸ªå½“å‰ç›¸å…³ Linux å‘è¡Œç‰ˆå·²ç»ä¸æ¨èé…ç½®äº†ï¼Œè¿™ä¸ªå¯ä»¥ä½¿ç”¨ `man interfaces` æŸ¥çœ‹è¯´æ˜ï¼Œåœ¨è¯´æ˜ä¸­å°† `netmask` æ˜ç¡®æ ‡æ³¨ä¸º **deprecated**ï¼ |

æœ€ç»ˆæˆ‘ä»¬çš„ interfaces æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```bash
source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface

# é…ç½®è‡ªå¯ ens33 ç½‘å¡
auto ens33
allow-hotplug ens33
# é™æ€ IP é…ç½®
iface ens33 inet static
     address 172.17.13.167/24
     gateway 172.17.13.254
```


| **æ³¨æ„**                                                     |
| :----------------------------------------------------------- |
| åœ¨ `/etc/network/interfaces` é…ç½®æ–‡ä»¶ä¸­åƒä¸‡ä¸è¦åœ¨é…ç½®ä¿¡æ¯è¡Œåé¢ä½¿ç”¨æ³¨é‡Š `#`ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´ç½‘ç»œé‡å¯å¤±è´¥ã€‚å¦å¤–ï¼Œçœ‹ä¸Šé¢çš„é…ç½®ä¿¡æ¯ï¼Œæ³¨æ„ç¼©è¿›ï¼ï¼ï¼ï¼ |


æœ€åé‡å¯ç½‘ç»œä½¿ç”¨å‘½ä»¤ï¼š

```bash
$ sudo systemctl restart networking.service

# æˆ–ä½¿ç”¨

$ sudo /etc/init.d/networking restart
```

å¦‚æœæ²¡æœ‰è¾“å‡ºé”™è¯¯ä¿¡æ¯å³è¡¨ç¤ºç½‘ç»œé…ç½®æˆåŠŸï¼

**æ³¨æ„ï¼š** ä½¿ç”¨ Network é…ç½®å®‰è£…ä¸Šè¿°æ–¹å¼é…ç½®é™æ€ IP æ—¶å¹¶æ²¡æœ‰è®¾ç½® DNS è§£æåœ°å€ï¼Œå¦‚æœé‡å¯ç½‘ç»œä¹‹å `ping baidu.com`Â æ—¶é‡åˆ°å¦‚ä¸‹é”™è¯¯å¯èƒ½çš„åŸå› åŸå› æ˜¯ DNS è§£æçš„é—®é¢˜ï¼Œå…·ä½“è§£å†³æ–¹å¼è§ FAQã€‚

```
Temporary failure in name resolution DNS
```

è¿™æ ·ï¼Œå³ä½¿è™šæ‹Ÿæœºé‡å¯ä¹Ÿä¸æ€• IP å˜åŒ–äº†~


## å¤šé™æ€ IP é…ç½®

æ—¢ç„¶éƒ½é…ç½®äº†é™æ€ IPï¼Œæ€ä¹ˆèƒ½å°‘å¾—äº†åœ¨ç½‘å¡ä¸Šé…ç½®å¤šä¸ªé™æ€ IP å‘¢çš„éœ€æ±‚å‘¢ï¼ˆè™½ç„¶è¿™ç§éœ€æ±‚å¾ˆ BTï¼‰ï¼Ÿ

é…ç½®å¤šä¸ªé™æ€ IP æ–¹å¼ä¸é…ç½®é™æ€ IPï¼Œç›´æ¥ä¿®æ”¹ `/etc/network/interfaces` æ–‡ä»¶å³å¯ï¼Œä¸è¿‡æœ‰ä¸¤ç§åˆ†é…æ–¹å¼ã€‚åˆ†åˆ«æ˜¯åŸºäº `iproute2` çš„æ–¹å¼ï¼ˆiproute2 methodï¼‰å’Œæ¯”è¾ƒè€çš„é…ç½®æ–¹å¼ï¼ˆLegacy methodï¼‰ã€‚

ç°åœ¨æ‰€æœ‰çš„å‘è¡Œç‰ˆé»˜è®¤éƒ½é›†æˆäº† `iproute2`ï¼Œä¼¼ä¹åªè¦ Linux å†…æ ¸ç‰ˆæœ¬å¤§äº 2.2 å°±æœ‰è¯¥å·¥å…·ã€‚ä½ å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ `ip`ï¼Œå¦‚æœæœ‰ç±»ä¼¼å¦‚ä¸‹çš„è¾“å‡ºå°±è¯´æ˜æœ‰ `iproute2` ç½‘ç»œå·¥å…·äº†ï¼š

```bash
$ ip
Usage: ip [ OPTIONS ] OBJECT { COMMAND | help }
       ip [ -force ] -batch filename

        ...
```

ç°åœ¨å°±åˆ†åˆ«æ¥çœ‹ä¸‹ï¼š


### åŸºäº iproute2 é…ç½®å¤šé™æ€ IP

é…ç½®èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åœ¨ä¹‹å‰é™æ€ IP çš„åŸºç¡€ä¸Šå¤šå†™å‡ ä¸ª `iface` å°±å¥½äº†ã€‚å¦‚ä¸‹ï¼š

```bash
source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface

# é…ç½®è‡ªå¯ ens33 ç½‘å¡
auto ens33
allow-hotplug ens33
# é™æ€ IP é…ç½®
iface ens33 inet static
     address 172.17.13.167/24
     gateway 172.17.13.254

# ç¬¬äºŒä¸ªé™æ€ IP
iface ens33 inet static
     address 172.17.13.168/24

# ç¬¬ä¸‰ä¸ªé™æ€ IP
iface ens33 inet static
     address 172.17.13.169/24
```

å”¯ä¸€éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œé™¤äº†ç¬¬ä¸€ä¸ª `iface` å¤–ï¼Œå…¶ä»–çš„ `iface` ä¸Šé™¤äº† `address` å¤–ä¸è¦é…ç½®å…¶ä»–ä»»ä½•ä¿¡æ¯ï¼Œå¦‚ `gateway` ä¹Ÿä¸è¦é…ç½®ï¼

æ‰€æœ‰é¢å¤–çš„ä¿¡æ¯è¦é…ç½®åœ¨ç¬¬ä¸€ä¸ª `iface` ä¸Šï¼å¦å¤–ï¼Œæ³¨æ„ `address` æŒ‡å®šçš„ IP ä¸è¦é‡å¤ï¼Œä¸”åœ¨å±€åŸŸç½‘å†…æ²¡æœ‰è¢«å ç”¨ï¼

ä¹‹åé‡å¯ç½‘ç»œå°±å¥½äº†ï¼š

```bash
$ systemctl restart networking.service
```

ä¹‹åæŸ¥çœ‹ä¸‹ IP ä¿¡æ¯ï¼š

```bash
$ ip -c addr show
```

è¾“å‡ºç¤ºä¾‹ï¼š

![multiple-ip-1637832393lrIgXO](http://linux-media.knowledge.ituknown.cn/NetworkManager/Debian-StaticIP/multiple-ip-1637832393lrIgXO.png)

ç°åœ¨å†æ¥çœ‹ä¸‹å¦‚æœå‘è¡Œç‰ˆæ²¡æœ‰ `iproute2` ç½‘ç»œç®¡ç†å·¥å…·å¤šé™æ€ IP è¯¥å¦‚ä½•é…ç½®ï¼š


## åŸºäº Legacyâ€‹ é…ç½®å¤šé™æ€ IP

è¿™ç§æ–¹å¼ä¸åŸºäº `iproute2` çš„é…ç½®æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ç½‘å¡ä¸Šï¼Œæ¥çœ‹ä¸‹å°†åŸºäº `iproute2` è½¬æ¢ä¸º Legacyâ€‹ çš„é…ç½®å½¢å¼ï¼š


```bash
source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface

# é…ç½®è‡ªå¯ ens33 ç½‘å¡
auto ens33
allow-hotplug ens33
# é™æ€ IP é…ç½®
iface ens33 inet static
     address 172.17.13.167/24
     gateway 172.17.13.254

# ç¬¬äºŒä¸ªé™æ€ IP
auto ens33:0
allow-hotplug ens33:0
iface ens33:0 inet static
     address 172.17.13.168/24

# ç¬¬ä¸‰ä¸ªé™æ€ IP
auto ens33:1
allow-hotplug ens33:1
iface ens33:1 inet static
     address 172.17.13.169/24
```

çœ‹åˆ°äº†ï¼Œæœ€å¤§çš„åŒºåˆ«å°±æ˜¯ç½‘å¡ã€‚ä½¿ç”¨ Legacyâ€‹ é…ç½®å¤šé™æ€ IP ä¸»è¦ä½¿ç”¨çš„æ˜¯è™šæ‹Ÿç½‘å¡çš„æ¦‚å¿µã€‚æˆ‘ä»¬çš„ç‰©ç†ç½‘å¡æ˜¯ ens33ï¼Œè€Œä¸‹é¢çš„ `ens33:[0-255]` å°±æ˜¯è™šæ‹Ÿç½‘å¡ã€‚

å¦ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œè™šæ‹Ÿç½‘å¡ä¹Ÿè¦ä½¿ç”¨ `auto` å’Œ `allow-hotplug` è¿›è¡Œæ¿€æ´»ï¼Œå¦åˆ™ä¹Ÿæ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚

æœ€åï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯åƒä¸‡ä¸è¦åœ¨è™šæ‹Ÿç½‘å¡ä¸Šé…ç½®é™¤äº† `address` ä¹‹å¤–çš„ä»»ä½•ä¿¡æ¯ã€‚è¿™ç‚¹ç›¸æ¯”è¾ƒåŸºäº `iproute2` çš„é…ç½®æ›´åŠ æ˜¾è‘—ï¼

ä¹‹åé‡å¯ç½‘ç»œå°±å¯ä»¥äº†~


## å½•å±ä¿¡æ¯

ä¸‹é¢æ˜¯ä½¿ç”¨ [asciinema](https://asciinema.org) å·¥å…·å½•åˆ¶çš„ Shell æ“ä½œç¤ºä¾‹ã€‚è¯¥ç¤ºä¾‹åŸºäº `iproute2` çš„ç½‘ç»œé…ç½®ï¼Œå¯ä»¥å‚è€ƒä¸‹ï¼š

[![asciicast](https://asciinema.org/a/451110.svg)](https://asciinema.org/a/451110)

# èµ„æºé“¾æ¥


[https://wiki.debian.org/NetworkConfiguration](https://wiki.debian.org/NetworkConfiguration)

[https://askubuntu.com/questions/143819/how-do-i-configure-my-static-dns-in-interfaces](https://askubuntu.com/questions/143819/how-do-i-configure-my-static-dns-in-interfaces)
â€‹

# FAQ
## Temporary failure in name resolution DNSï¼Ÿ


è¯¥é—®é¢˜çš„å¯èƒ½åŸå› æ˜¯ç½‘å…³é…ç½®é”™è¯¯ï¼Œæ¯”å¦‚æŒ‰ç…§ä¸Šè¿°æœ¬æ–‡è¯´æ˜é…ç½®çš„ IP åœ°å€ä¸ºï¼š `192.168.0.112/24`Â ã€‚é‚£ä¹ˆç½‘æ®µå°±æ˜¯ `192.168.0`Â ï¼Œæ‰€ä»¥ç½‘å…³çš„åœ°å€å°±æ˜¯ `192.168.0.1~225`Â ä¹‹é—´ï¼Œå…·ä½“æ˜¯å…¶ä¸­çš„å“ªä¸€ä¸ªå¯ä»¥ä½¿ç”¨ `netstat -rn`Â å‘½ä»¤è¿›è¡Œç¡®å®šã€‚


å¦‚æœå°†ç½‘å…³åœ°å€è®¾ç½®ä¸º `192.168.1.1`Â é‚£ä¹ˆè‚¯å®šä¼šå‡ºç°è¯¥é”™è¯¯çš„ã€‚


é™¤äº†ç½‘å…³çš„åŸå› ä¹‹å¤–ï¼Œè¿˜ä¸€ä¸ªåŸå› å¯èƒ½æ˜¯ DNS é…ç½®é”™è¯¯ã€‚å¦‚å‰é¢è¯´çš„ï¼Œåœ¨æŸ¥çœ‹ `/etc/resolv.conf`Â æ–‡ä»¶å¾—åˆ°çš„ DNS åœ°å€ `127.0.0.53`Â ã€‚å¦‚æœåœ¨é…ç½®é™æ€ IP æ—¶å°† DNS è§£æåœ°å€è®¾ç½®ä¸ºè¯¥å€¼é‚£ä¹ˆä¹Ÿå¯èƒ½ä¼šå¾—åˆ°è¯¥é”™è¯¯ï¼Œè§£å†³æ–¹å¼å°±æ˜¯åœ¨é…ç½®é™æ€ IP æ—¶å°† DNS é¦–é€‰è§£æåœ°å€è®¾ç½®ä¸ºå›½å†…çš„ `114.114.114.114`Â ï¼Œå¦å¤–è¿˜å¯ä»¥åŠ ä¸Šè°·æ­Œçš„ DNS è§£æåœ°å€ `8.8.8.8`Â ã€‚


æ¯”å¦‚åŸºäº Netplan é…ç½® DNS åœ°å€ï¼š


```yaml
network:
  version: 2
  ethernets:
    ens33:
      nameservers:
        addresses:
        - 114.114.114.114 # å›½å†…é¦–é€‰ DNS è§£æåœ°å€
        - 8.8.8.8         # è°·æ­Œ DNS è§£æåœ°å€
```


å¦‚æœæ˜¯åŸºäº Network é…ç½®çš„è¯å¯ä»¥é€šè¿‡ä¿®æ”¹ `/etc/systemd/resolved.conf`Â æ–‡ä»¶è¿›è¡Œè®¾ç½® DNS è§£æåœ°å€ã€‚å°†è¯¥æ–‡ä»¶ä¸­çš„ DNS å€¼é¦–é€‰è®¾ç½®ä¸º `114`Â ä¹‹åå†è·Ÿä¸€ä¸ªè°·æ­Œçš„ `8.8` ï¼š
```
[Resolve]
DNS=114.114.114.114 8.8.8.8
```
ç›®å‰ç¬”è€…çŸ¥é“çš„è§£å†³æ–¹å¼å°±è¿™ä¸¤ç§ï¼Œå¦‚æœè¿˜æ˜¯æ— æ³•è§£å†³è¯¥é—®é¢˜å°±å‘åº¦å¨˜ã€è°·æ­Œæ±‚åŠ©äº†~





# åŸºäº Netplan é…ç½®ç½‘ç»œ


netplan ä¸ä¹‹å‰çš„ç‰ˆæœ¬çš„ç½‘ç»œé…ç½®æœ‰äº›åŒºåˆ«ï¼Œå®ƒçš„ç½‘ç»œé…ç½®æ–‡ä»¶åœ¨ `/etc/netplan` ç›®å½•ä¸‹é¢ã€‚è¯¥ç›®å½•ä¸‹å¯èƒ½å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œå°±åªæœ‰ä¸€ä¸ªç½‘ç»œé…ç½®æ–‡ä»¶ï¼š


```bash
$ ls /etc/netplan/

50-cloud-init.yaml
```


ä»æ–‡ä»¶å‘½åä¹Ÿèƒ½çœ‹å‡ºä¸€äº›åŒºåˆ«ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºäº YAML çš„é…ç½®æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¸­é»˜è®¤æœ‰äº›é…ç½®ä¿¡æ¯ï¼š


```bash
$ cat /etc/netplan/50-cloud-init.yaml

network:
  ethernets:
    ens33:
      dhcp4: true
  version: 2
```


å½“å‰è¿˜æœ‰å…¶ä»–çš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œæˆ‘ä»¬æš‚æ—¶å…ˆä¸ç®¡ã€‚æˆ‘ä»¬ç”±äºè¦è¿›è¡Œé…ç½®é™æ€ç½‘ç»œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆéœ€è¦æŸ¥æ‰¾ä¸€äº›åŸºæœ¬çš„é…ç½®ä¿¡æ¯ï¼š


**æŸ¥æ‰¾ç½‘å…³**


```bash
$ netstat -rn

Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         192.168.0.1     0.0.0.0         UG        0 0          0 ens33
172.17.0.0      0.0.0.0         255.255.0.0     U         0 0          0 docker0
192.168.0.0     0.0.0.0         255.255.255.0   U         0 0          0 ens33
```


å…¶ä¸­ç¬¬ä¸€æ¡è¾“å‡ºä¿¡æ¯ä¸­çš„ IP `192.168.0.1` å°±æ˜¯æˆ‘ä»¬çš„ç½‘å…³ï¼Œå…ˆè®°ä¸‹ã€‚


**æŸ¥æ‰¾ DNS**


è¿™ä¸ª DNS ç›´æ¥åœ¨ `/etc/resolv.conf` ä¸­è¿›è¡ŒæŸ¥æ‰¾å³å¯ï¼š


```bash
$ cat /etc/resolv.conf | grep nameserver
nameserver 127.0.0.53
```


å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘è¿™æ˜¯åœ¨å±€åŸŸç½‘å†…ï¼Œæ‰€ä»¥ DNS æœåŠ¡åœ°å€æ˜¯ `127.0.0.53` ã€‚


ä½†æ˜¯å¦‚æœåœ¨é…ç½®é™æ€ IP æ—¶å°† DNS è§£æåœ°å€è®¾ç½®æˆè¯¥å€¼å°±æ— æ³•è¿æ¥ç½‘ç»œã€‚æ¯”å¦‚ `ping baidu.com`Â æ—¶å°±ä¼šæç¤ºå¦‚ä¸‹é”™è¯¯ï¼š


```
Temporary failure in name resolution DNS
```


æ‰€ä»¥ï¼Œåœ¨é…ç½®é™æ€ IP æ—¶æˆ‘ä»¬éœ€è¦å°† DNS è§£æåœ°å€è®¾ç½®ä¸º `114.114.114.114`Â æˆ–è€… `8.8.8.8`Â ã€‚


å…¶ä¸­ `114.114.114.114`Â æ˜¯å›½å†…çš„ DNS è§£æåœ°å€ï¼Œ `8.8.8.8`Â æ˜¯è°·æ­Œçš„ DNS è§£æåœ°å€ã€‚åœ¨è®¾ç½® DNS è§£ææ—¶ï¼Œå¦‚æœä»…ä»…è®¾ç½®ä¸º `8.8.8.8`Â çš„è¯åœ¨å›½å†…..... ï¼Œæ‰€ä»¥åœ¨å®é™…ä½¿ç”¨ä¸­æœ€å¥½å°†ä¸¤è€…å…¨éƒ¨é…ç½®ä¸Šå»ã€‚


æ‰¾åˆ°ä¸Šé¢çš„ä¸¤ä¸ªä¿¡æ¯ä¹‹åå°±å¼€å§‹åšå…·ä½“é…ç½®äº†ï¼Œå…³äº YAML é…ç½®æ–‡ä»¶æœ‰å“ªäº›é…ç½®ä¿¡æ¯å¯ä»¥ä½¿ç”¨ man å‘½ä»¤æŸ¥çœ‹ netplan çš„è¯¦ç»†ä¿¡æ¯ï¼Œä»‹ç»çš„å¾ˆè¯¦ç»†ã€‚


```bash
man netplan
```


å…ˆæ¥çœ‹ä¸‹æˆ‘çš„é…ç½®æ–‡ä»¶ä¸­å†…å®¹ï¼š


```yaml
network:
  version: 2
  ethernets:
    ens33:
      dhcp4: no
      optional: no
      addresses:
      - 192.168.0.112/24
      gateway4: 192.168.0.1
      nameservers:
        addresses:
        - 114.114.114.114 # å›½å†… DNS è§£æåœ°å€
        - 8.8.8.8 # è°·æ­Œ DNS è§£æåœ°å€
```


`network.version` è¿™ä¸ªä¿¡æ¯æ˜¯æ­»çš„ï¼Œä¸ç”¨ç®¡ã€‚æˆ‘ä»¬ä¸»è¦å…³å¿ƒçš„æ˜¯ `network.ethernets` ç½‘å¡ä¸‹çš„é…ç½®ä¿¡æ¯ã€‚


`ens33` æŒ‡çš„æ˜¯ç½‘ç»œæ¥å£ï¼Œå¤§å¤šæ•°ç”¨çš„çš„ç½‘ç»œæ¥å£åéƒ½æ˜¯ `ens0`ã€‚æ€ä¹ˆçŸ¥é“è‡ªå·±çš„ç½‘ç»œæ¥å£åå‘¢ï¼Ÿç›´æ¥ä½¿ç”¨ `ifconfig` å‘½ä»¤æŸ¥çœ‹è¾“å‡ºçš„ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…å«è‡ªå·± IP çš„é‚£ä¸ªå°±æ˜¯ä½ çš„ç½‘ç»œæ¥å£åï¼Œæ¯”å¦‚æˆ‘çš„ï¼š


```bash
$ ifconfig

...
ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.0.117  netmask 255.255.255.0  broadcast 192.168.0.255
        inet6 fe80::20c:29ff:fecd:48cf  prefixlen 64  scopeid 0x20<link>
        ether 00:0c:29:cd:48:cf  txqueuelen 1000  (Ethernet)
        RX packets 140745  bytes 93399083 (93.3 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 28012  bytes 2392981 (2.3 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

...
```


æŒ‡å®šäº†ç½‘ç»œæ¥å£åå°±å¯ä»¥è¿›è¡Œè®¾ç½®è¯¥æ¥å£ä¸‹æŒ‡å®šçš„ IP æ˜¯é™æ€è¿˜æ˜¯åŠ¨æ€äº†ã€‚


åœ¨ä»¥å¾€åŸºäº Netwoek çš„é…ç½®ä¸­éƒ½æ˜¯å°† `dncp` æ›¿æ¢ä¸º `static` è¡¨ç¤ºä½¿ç”¨é™æ€ IPï¼Œä½†æ˜¯ `netplan` åˆ™ä¸åŒï¼Œä½¿ç”¨ yes æˆ– no è¡¨ç¤ºä½¿ç”¨é™æ€è¿˜æ˜¯åŠ¨æ€ã€‚


å¯ä»¥çœ‹åˆ°æˆ‘è¿™é‡Œé…ç½®çš„æ˜¯ `dhcp4: no` è¡¨ç¤ºé™æ€ IPv4ã€‚å¦‚æœä½ è¦è®¾ç½®é™æ€ IPv6 å°±è®¾ç½® `dhcp6: no` å°±å¥½ã€‚


`optional` æŒ‡çš„æ˜¯æ˜¯å¦ä¸ºå¯é€‰ï¼Œä¸æ‡‚å•¥æ„æ€ï¼Œä¸é…ç½®ä¹Ÿæ²¡å…³ç³»ã€‚


åœ¨ä¹‹åå°±æ˜¯ `addresses` çš„é…ç½®äº†ï¼Œè¿™é‡Œå°±æ˜¯è¿›è¡Œè®¾ç½®ä½ è¦è®¾ç½®çš„é™æ€ IPï¼Œæ”¯æŒå¤šä¸ªï¼Œä¹Ÿæ”¯æŒæ•°ç»„è¾“å…¥ï¼Œç¤ºä¾‹ï¼š


```yaml
network:
  version: 2
  ethernets:
    ens33:
      dhcp4: no
      optional: no
      addresses:
      - 192.168.0.112/24
      - 192.168.0.117/24

# æˆ–è€…

network:
  version: 2
  ethernets:
    ens33:
      dhcp4: no
      optional: no
      addresses: [192.168.0.112/24, 192.168.0.117/24]
```


å†ä¹‹åå°±æ˜¯è¿›è¡Œé…ç½®ç½‘å…³äº†ï¼Œä¸ `dhcp` ä¸€æ ·ï¼Œä¹Ÿæ˜¯æ”¯æŒé…ç½® IPv4 å’Œ IPv6ã€‚æ¯”å¦‚ä¸Šé¢æˆ‘é…ç½®çš„æ˜¯ IPv4ï¼ŒIP å°±æ˜¯æ–‡ç« å¼€å§‹æŸ¥æ‰¾å¾—åˆ°çš„ IPï¼š


```yaml
network:
  version: 2
  ethernets:
    ens33:
      gateway4: 192.168.0.1 # é…ç½® IPv4 ç½‘å…³
      # gateway6: # é…ç½® IPv6 ç½‘å…³
```


`nameservers` é…ç½®çš„æ˜¯ DNS è§£ææœåŠ¡å™¨ï¼Œä¸‹é¢çš„å±æ€§ `addresses` æ˜¯é…ç½®å…·ä½“çš„ DNS æœåŠ¡å™¨åœ°å€ã€‚åŒæ ·æ”¯æŒå¤šä¸ªå’Œæ”¯æŒæ•°ç»„è¾“å…¥ï¼š


```yaml
network:
  version: 2
  ethernets:
    ens33:
      nameservers:
        addresses:
        - 114.114.114.114   # å›½å†…é¦–é€‰ DNS è§£æåœ°å€
        - 8.8.8.8           # å›½å¤–è°·æ­Œ DNS è§£æåœ°å€
```


æœ€åä¿å­˜å³å¯ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ä½¿é…ç½®ç”Ÿæ•ˆï¼š


```bash
sudo netplan apply
```


ä¹‹ååœ¨æŸ¥çœ‹è‡ªå·±çš„ IP å°±å‘ç° IP å˜æˆäº†è‡ªå·±é…ç½®çš„ IP äº†ï¼Œå³ä½¿å…³æœºé‡å¯ IP ä¹Ÿä¸å†å‘ç”Ÿå˜åŒ–äº†ï¼š


```bash
$ ifconfig

...
ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.0.112  netmask 255.255.255.0  broadcast 192.168.0.255
        inet6 fe80::20c:29ff:fecd:48cf  prefixlen 64  scopeid 0x20<link>
        ether 00:0c:29:cd:48:cf  txqueuelen 1000  (Ethernet)
        RX packets 140745  bytes 93399083 (93.3 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 28012  bytes 2392981 (2.3 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

...
```



| æ³¨æ„ |
| --- |
| åœ¨è¿›è¡Œè®¾ç½®é™æ€ IP æ—¶ï¼Œå¦‚æœæŒ‡å®šçš„ IP ä¸æ˜¯å½“å‰æœºå™¨æ­£åœ¨ä½¿ç”¨çš„ IP çš„è¯ä¸€å®šè¦ä¿è¯é€‰æ‹©çš„ IP å¹¶æ²¡æœ‰è¢«å ç”¨ã€‚åœ¨é…ç½®è¯¥ IP ä¹‹å‰å…ˆä½¿ç”¨ `ping` å‘½ä»¤çœ‹èƒ½å¦ PING çš„é€šï¼Œå¦‚æœé€šäº†å°±è¡¨ç¤ºè¯¥ IP å·²è¢«å ç”¨ï¼Œå°±ä¸èƒ½è¿›è¡Œè®¾ç½®æˆè¯¥ IP äº†ã€‚ |



https://lists.debian.org/debian-user/2017/09/msg00911.html

https://unix.stackexchange.com/questions/641228/etc-network-interfaces-difference-between-auto-and-allow-hotplug

http://manpages.ubuntu.com/manpages/cosmic/man5/interfaces.5.html

https://wiki.ubuntu.org.cn/UbuntuæœåŠ¡å™¨å…¥é—¨æŒ‡å—